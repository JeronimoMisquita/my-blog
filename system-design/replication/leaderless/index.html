
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jeronimo Misquita's Personal Website and Software Engineering blog">
      
      
      
        <link rel="canonical" href="https://JeronimoMisquita.github.io/system-design/replication/leaderless/">
      
      
        <link rel="prev" href="../multi-leader/">
      
      
        <link rel="next" href="../../partitioning/overview/">
      
      
        
      
      
      <link rel="icon" href="../../../images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Leaderless - Jeronimo Misquita</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#leaderless" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Jeronimo Misquita" class="md-header__button md-logo" aria-label="Jeronimo Misquita" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jeronimo Misquita
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Leaderless
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  About Me

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../overview/" class="md-tabs__link">
          
  
  
  System Design

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../books/readings/" class="md-tabs__link">
          
  
  
  Book Shelf

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../projects/pdf-utilities/" class="md-tabs__link">
          
  
  
  Projects

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../blog/" class="md-tabs__link">
        
  
  
    
  
  Blog

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../health/groceries/" class="md-tabs__link">
          
  
  
  Health

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Jeronimo Misquita" class="md-nav__button md-logo" aria-label="Jeronimo Misquita" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Jeronimo Misquita
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About Me
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    System Design
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    System Design
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Replication
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Replication
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../single-leader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Single Leader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-leader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi Leader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Leaderless
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Leaderless
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-staleness" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring staleness
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#single-leader-vs-leaderless-application-performance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Single leader vs Leaderless application performance
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-region-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi Region operation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detecting-concurrent-writes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Detecting concurrent writes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Detecting concurrent writes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#last-write-wins-concurrency-resolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Last Write Wins concurrency resolution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-version-number" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using version number
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Partitioning
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Partitioning
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../partitioning/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Book Shelf
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Book Shelf
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../books/readings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Books I've read
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Projects
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Projects
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../projects/pdf-utilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pdf utilities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../blog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Health
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Health
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../health/groceries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ðŸ›’ My Shopping List
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-staleness" class="md-nav__link">
    <span class="md-ellipsis">
      
        Monitoring staleness
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#single-leader-vs-leaderless-application-performance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Single leader vs Leaderless application performance
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-region-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multi Region operation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detecting-concurrent-writes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Detecting concurrent writes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Detecting concurrent writes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#last-write-wins-concurrency-resolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Last Write Wins concurrency resolution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-version-number" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using version number
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="leaderless">Leaderless</h1>
<h2 id="overview">Overview</h2>
<p>In both single leader and multi-leader replication, the leader receives the writes, orders them some way and ensures changes are replicated. Followers just apply changes in the same order as the leader.</p>
<p>In leaderless replication there is no leader at all. Such databases are called <strong>Dynamo Style DBs</strong>. Common products are Cassandra, Riak, etc. (Amazon DynamoDB is actually based on single-leader replication based on the Multi Paxos consensus algorithm).</p>
<p>In this approach, any replica can accept write requests.</p>
<p>In some implementations:</p>
<ul>
<li>The client sends the same write to several replicas in parallel.</li>
<li>The client sends a write to one replica (<strong>coordinator</strong>) that forwards it in parallel to several other replicas. Unlike leader-based systems, the coordinator does not enforce any ordering of subsequent writes.</li>
</ul>
<p>Basically,</p>
<ul>
<li>We try to write to all nodes N. Say N=3.</li>
<li>Imagine one node is down.</li>
<li>Then the 2 alive nodes accept the write and the write succeeds. We simply ignore the fact that one of the nodes replied in error.</li>
<li>When the node that was down comes back, it catches up with the data in one of 3 ways:<ul>
<li><strong>Read Repair</strong>: The client makes a read request to several replicas in parallel. The client notices that 1 node has stale data and updates it.</li>
<li><strong>Hinted Handoff</strong>: Another replica accepts the missed writes in the form of hints. When the replica that was supposed to receive the writes comes back, the replica storing the hints sends them to the recovered replica and then deletes the hints.</li>
<li><strong>Anti-Entropy</strong>: A background process periodically synchronizes data across replicas.</li>
</ul>
</li>
</ul>
<p><strong>The core idea:</strong>
If there exists a set of nodes N.
Then you try to write to all of them in parallel, but the write succeeds if any subset W of them confirm the write operation.
Similarly, a read succeeds if any R of them give some response.</p>
<p>WhenW + R &gt; N, then the read or write is said to be a <strong>Strict Quorum read</strong> or <strong>Strict Quorum write</strong>. 
The condition ensures that when reading there is at least one overlapping node with the written node so you will always get at least one node with the latest data.
The client uses the data version number to figure out which node has the freshest data and uses that. The client can then fix data on other nodes with an additional write.</p>
<p>Interestingly, the values of W and R can be set depending on your use case. If your DB has many reads and very few writes, then setting R=1 and W=N can be useful. I.e. only 1 node needs to be queried or return a value to the client (quite fast).
However, if even 1 node is not working, writes cannot be applied in this config.</p>
<p>In general, we set N to be an odd number (e.g 3 or 5), then set W=R=(N+1)/2. I.e. if N=3 then W=2 and R=2. One node failure is okay.</p>
<p>Also in general:</p>
<ul>
<li>if R &lt; N, read can work if a node is down.</li>
<li>if W &lt; N, write can work if a node is down.</li>
<li>N=5, W=3, R=3 can tolerate 2 down nodes.</li>
</ul>
<p>In practice, writes and reads are sent to all replicas in parallel and values of R and W dictate how many of the N nodes need to report a success before we consider the read or write operation to be successful.</p>
<blockquote>
<p><strong>Note:</strong> if fewer than R or W nodes return success for read and writes respectively, the operation is considered a failure.</p>
<p><strong>Note:</strong> Sharding is also possible by having shards of leaderless node groups. Therefore in practice, the number of nodes can be much more than N.</p>
</blockquote>
<p>The formula, W+R&gt;N guarantees that there is at least one node overlapping between nodes written to and read from.</p>
<p>It's quite common to choose R and W values more than N/2. This not only ensures R+W &gt; N but also provides a lot of fault tolerance. I.e. at least N/2 rounded down node failures before the system becomes unusable, i.e. the system cannot provide R or W responses for read or write respectively.</p>
<p>If you don't really care about always reading the latest value (some staleness is acceptable) then R and W can be much lower values. I.e. W+R &lt;= N. Here a read may not give back the latest value but the configuration provides higher availability and lower latency. Again, the system cannot read if available nodes become less than R and the system cannot be written to when the number of nodes becomes less than W.</p>
<p><strong>Select leaderless replication when:</strong></p>
<ul>
<li><strong>Prioritizing Availability:</strong> The ability for the system to continue operating and accepting writes at all times is more critical than having the absolute latest data immediately (e.g. social media feeds, logging, session stores, e-commerce shopping carts).</li>
<li><strong>Tolerance for Stale Reads:</strong> Your application can tolerate reading temporarily stale data, knowing that the data will eventually be consistent.</li>
<li><strong>High Resilience:</strong> You need strong protection against node failures and network partitions (fault tolerance).</li>
<li><strong>High Write Volume:</strong> You have a high volume of writes that need to be distributed across many nodes to achieve the required throughput.</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<p>Even when the W+R &gt; N condition is met, we have the following issues:</p>
<ul>
<li>Issue of concurrent writes. It's not clear which one happened first. If a clock is used for a tie-breaker, clock skew is a problem.</li>
<li>As a write is propagating and updating nodes, a simultaneous read may hit overlapping or different nodes. It's unclear if the read sees the updated records or not while the write is in progress. It's not deterministic.</li>
<li>If some nodes' write succeeds and fails on the majority of others, few successful writes are not rolled back. A subsequent quorum read may or may not return updated data.</li>
<li>If a write succeeds and 3 of 5 nodes got data, it can happen that one of the 3 nodes failed and was restored by a replica without data. The number of nodes with correct data is now 2 of 5, breaking the quorum condition even though the original write succeeded.</li>
</ul>
<blockquote>
<p><strong>WARNINGS with leaderless replication:</strong>
As discussed in disadvantages, even when the quorum condition is met R+W&gt;N. The system still may not always guarantee fresh data on read (due to edge cases).
Leaderless replication can <strong>NOT</strong> guarantee:</p>
<ul>
<li>Read your own writes</li>
<li>Monotonic read</li>
<li>Consistent prefix reads</li>
</ul>
<p>Stronger guarantees need transactions or consensus (discussed later).</p>
</blockquote>
<h2 id="monitoring-staleness">Monitoring staleness</h2>
<p>In a single leader DB, the leader and replicas apply the same writes in the same order. By comparing the number of writes applied by a follower to the leader, the lag can easily be calculated.
Replication lag is a very useful metric.</p>
<p>In a leaderless system, staleness can be represented by the amount of hints a replica is holding for handoff.
However, if the DB uses read repair then staleness can be un-ending and depends on how frequently data is accessed and discrepancies are discovered and fixed.</p>
<h2 id="single-leader-vs-leaderless-application-performance">Single leader vs Leaderless application performance</h2>
<p><strong>Single Leader</strong></p>
<ul>
<li>Reads made to the leader are always consistent and return up-to-date data. However, leader read throughput can be limited. You can also make a consistent read to a sync replica.</li>
<li>Reads to async replicas can return stale data.</li>
<li>If the leader fails, you have to wait till it's detected and failover is completed.</li>
<li>The system is very sensitive to performance problems on the leader node.</li>
</ul>
<p><strong>Leaderless replication</strong></p>
<ul>
<li>No Failover. However, one replica needs to detect if another one is unavailable so it can store hints about writes that the replica missed. When the replica is back, the handoff process to send hints puts additional load on the replicas to process those hints, when the system can already be under strain.</li>
<li>The more replicas you have, the larger the W or R size to form strict quorums. Even if you make responses in parallel, larger R and W values increase the chance of encountering slow nodes.</li>
<li>A large network disruption may make a large number of nodes unavailable to a client. The client may decide to store the writes in nodes of a different unrelated shard, hoping for handoff later to sync them (<strong>Sloppy quorum</strong>) to the destination shard. This might be a good option to prevent dropping writes. Reads made to correct shards may not see the data until handoff is completed.</li>
</ul>
<p><strong>Multi Leader</strong></p>
<ul>
<li>The client can communicate to the local leader (less network disruption so more reliable).</li>
<li>However, writes need to be propagated across to other leaders and nodes so reads can be arbitrarily out of date if performed on replicas.</li>
</ul>
<p>Quorum read and write in leaderless replicaiton, provide a compromise: good fault tolerance and a high likelihood of reading up-to-date data.</p>
<h2 id="multi-region-operation">Multi Region operation</h2>
<ul>
<li>The client sends a write request to one node in its region. That node acts as a coordinator and forwards requests to all other nodes in the same region as well as one node in every other region. The node in the other region acts as a coordinator node and forwards data to local replicas. This avoids making cross-region requests multiple times.</li>
<li>You can choose consistency levels that choose how many responses are required for a request to be successful. For example, you can request quorum across all replicas in all regions, a separate quorum in each region, or a quorum in the client's local region only. A local quorum avoids having to wait for slow requests from other regions but increases the likelihood of stale results for clients in other regions.</li>
<li>Riak always prefers local quorums, and cross-region replication happens in the background in a style similar to multi-leader replication.</li>
</ul>
<h2 id="detecting-concurrent-writes">Detecting concurrent writes</h2>
<p>In a leaderless system, a node accepts writes from many clients even for the same key.</p>
<p>Given 2 clients A and B updating some key K. Then 3 things are possible:</p>
<ol>
<li>A operation happens before B</li>
<li>A happens after B</li>
<li>A and B are concurrent</li>
</ol>
<p>A happens after B, means A was aware of data inserted/updated by B. I.e. if we are updating a user profile, and if B was updating the address and A was updating the name. Then after A completed, both address and name were updated because A was aware of the data changed by B.</p>
<p>Concurrent (3) means that A and B are not aware of the other's operation. They don't always have to be simultaneously executing in time (although it can be the case when concurrent access happens).</p>
<h3 id="last-write-wins-concurrency-resolution">Last Write Wins concurrency resolution</h3>
<p>In this approach, all clients include some increasing identifier like a timestamp. The nodes simply preserve the data inserted by the latest identifier and discard other older versions.</p>
<p><strong>Issues with this approach:</strong></p>
<ol>
<li><strong>Clock skew</strong> - 2 clients may have out-of-sync clocks, so the identifiers are not reliable and can lead to incorrect ordering.</li>
<li><strong>Data loss</strong> - If clients are updating different parts of the data concurrently e.g. one is updating the name and the other the address. Simply keeping the last write will lead to data loss of one part of the data.</li>
</ol>
<h3 id="using-version-number">Using version number</h3>
<p>Imagine a single node system.</p>
<ul>
<li>Every time you write to the DB for a key, the DB updates the value and assigns an incrementing version number to it. The write returns back the value as well as the new version number.</li>
<li>The version indicates the value state inside DB the client received. The client can make further modifications and write back to the DB but it must include the version number it got in the last read. Including the version number tells the DB what past version the client knew before he made this update.</li>
<li>If the DB has some newer version than what the client is writing with (maybe due to some concurrent writes from other clients in the meantime), the DB does not discard the write, it saves it as an additional value in the DB. So now the key has 2 values. The DB then in response returns both values as a write response along with an incremented version number (the version number marks that there are 2 values for the key). It is the responsibility of the client then to merge the 2 values and write back to the DB a single value.</li>
</ul>
<p>In this approach, all values written by concurrent updates are preserved and sent back to the client as a write response. It's the job of the client to merge them in a meaningful way.</p>
<blockquote>
<p><strong>Note:</strong> If the value was a list of shopping cart items. Then if clients were deleting items, it's better not to physically delete them but to add a tombstone that represents the delete.
During the final merging of concurrent lists, you have more information to do the merge correctly. Otherwise, you may end up adding back things that were deleted.</p>
</blockquote>
<p>In practice, each node keeps track of its own version number.
The collection of versions numbers across all replicas is called a <strong>version vector</strong>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "toc.follow"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>